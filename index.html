<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realistic Forest Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #gameContainer { position: relative; width: 100vw; height: 100vh; }
        #uiOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            pointer-events: none; padding: 20px; box-sizing: border-box;
        }
        .ui-element {
            background-color: rgba(0,0,0,0.5); color: #fff; padding: 10px;
            border-radius: 5px; font-size: 16px;
        }
        #ammo { align-self: flex-end; }
        #controls { align-self: center; text-align: center; }
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px; pointer-events: none;
        }
        #startScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: rgba(0,0,0,0.8); color: #fff;
        }
        #startButton {
            padding: 10px 20px; font-size: 20px; margin-top: 20px;
            background-color: #4CAF50; color: white; border: none;
            cursor: pointer; transition: background-color 0.3s;
        }
        #startButton:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="uiOverlay">
            <div id="ammo" class="ui-element">Ammo: 30</div>
            <div id="controls" class="ui-element">WASD to move, Mouse to look, Left Click to shoot</div>
        </div>
        <img id="crosshair" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABCSURBVDhPY/j//z8DLQETlKYZGDUQD6C/gf+xYGzqCNqCzzCYOC4xogDdfZSyGdVAWmIcBqKTDDYxogBdHc3yIQMDAKuogJ9Jv1vqAAAAAElFTkSuQmCC" alt="Crosshair">
        <div id="startScreen">
            <h1>Realistic Forest Explorer</h1>
            <button id="startButton">Start Game</button>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls, player, mixer, clock;
        let trees = [], bullets = [];
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let ammo = 30;
        let playerGun, shootingAction;

        const loadingManager = new THREE.LoadingManager();
        const textureLoader = new THREE.TextureLoader(loadingManager);
        const gltfLoader = new THREE.GLTFLoader(loadingManager);

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x89b2eb, 0.002);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 1.6;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('gameContainer').appendChild(renderer.domElement);

            controls = new THREE.PointerLockControls(camera, renderer.domElement);

            clock = new THREE.Clock();

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
            sunLight.position.set(100, 100, 0);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            scene.add(sunLight);

            // Skybox
            const skyboxTexture = textureLoader.load('https://threejsfundamentals.org/threejs/resources/images/equirectangularmaps/tears_of_steel_bridge_2k.jpg');
            const skyboxGeometry = new THREE.SphereGeometry(500, 60, 40);
            const skyboxMaterial = new THREE.MeshBasicMaterial({ map: skyboxTexture, side: THREE.BackSide });
            const skybox = new THREE.Mesh(skyboxGeometry, skyboxMaterial);
            scene.add(skybox);

            // Ground
            const groundTexture = textureLoader.load('https://threejsfundamentals.org/threejs/resources/images/checker.png');
            groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
            groundTexture.repeat.set(100, 100);
            groundTexture.anisotropy = 16;

            const groundMaterial = new THREE.MeshLambertMaterial({ map: groundTexture });
            const groundMesh = new THREE.Mesh(new THREE.PlaneBufferGeometry(1000, 1000), groundMaterial);
            groundMesh.rotation.x = -Math.PI / 2;
            groundMesh.receiveShadow = true;
            scene.add(groundMesh);

            // Load player model (Three.js mascot - robot)
            gltfLoader.load('https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb', (gltf) => {
                player = gltf.scene;
                player.scale.set(0.5, 0.5, 0.5);
                player.position.set(0, 0, -2);
                camera.add(player);

                mixer = new THREE.AnimationMixer(player);
                const idleAction = mixer.clipAction(gltf.animations[0]);
                idleAction.play();

                // Add gun to player's hand
                const gunGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.3);
                const gunMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });
                playerGun = new THREE.Mesh(gunGeometry, gunMaterial);
                playerGun.position.set(0.3, -0.1, -0.5);
                camera.add(playerGun);

                scene.add(camera);
            });

            // Create trees
            const treeGeometry = new THREE.ConeGeometry(1, 4, 6);
            const treeMaterial = new THREE.MeshLambertMaterial({ color: 0x2d4c1e });

            for (let i = 0; i < 200; i++) {
                const tree = new THREE.Mesh(treeGeometry, treeMaterial);
                tree.position.set(
                    Math.random() * 200 - 100,
                    2,
                    Math.random() * 200 - 100
                );
                tree.castShadow = true;
                tree.receiveShadow = true;
                scene.add(tree);
                trees.push(tree);
            }

            // Event listeners
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('click', onMouseClick);
            window.addEventListener('resize', onWindowResize);

            document.getElementById('startButton').addEventListener('click', startGame);

            loadingManager.onLoad = () => {
                document.getElementById('startButton').disabled = false;
            };
        }

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            controls.lock();
        }

        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyD': moveRight = true; break;
            }
        }

        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyD': moveRight = false; break;
            }
        }

        function onMouseClick() {
            if (controls.isLocked && ammo > 0) {
                shoot();
                ammo--;
                updateUI();
            }
        }

        function shoot() {
            const bulletGeometry = new THREE.SphereGeometry(0.05, 8, 8);
            const bulletMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);

            bullet.position.set(
                camera.position.x,
                camera.position.y,
                camera.position.z
            );

            bullet.velocity = new THREE.Vector3(
                -Math.sin(camera.rotation.y),
                0,
                -Math.cos(camera.rotation.y)
            );

            scene.add(bullet);
            bullets.push(bullet);

            // Gun recoil animation
            const recoilTween = new TWEEN.Tween(playerGun.rotation)
                .to({ x: -0.2 }, 50)
                .easing(TWEEN.Easing.Quadratic.Out)
                .onComplete(() => {
                    new TWEEN.Tween(playerGun.rotation)
                        .to({ x: 0 }, 100)
                        .easing(TWEEN.Easing.Quadratic.InOut)
                        .start();
                })
                .start();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function updateUI() {
            document.getElementById('ammo').textContent = `Ammo: ${ammo}`;
        }

        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();

            if (controls.isLocked) {
                const speed = 5;
                const velocity = new THREE.Vector3();

                if (moveForward) velocity.z -= speed * delta;
                if (moveBackward) velocity.z += speed * delta;
                if (moveLeft) velocity.x -= speed * delta;
                if (moveRight) velocity.x += speed * delta;

                controls.moveRight(velocity.x);
                controls.moveForward(velocity.z);
            }

            // Update bullets
            for (let i = 0; i < bullets.length; i++) {
                bullets[i].position.add(bullets[i].velocity);

                // Remove bullets that have travelled too far
                if (bullets[i].position.length() > 100) {
                    scene.remove(bullets[i]);
                    bullets.splice(i, 1);
                    i--;
                }
            }

            if (mixer) mixer.update(delta);

            TWEEN.update();

            renderer.render(scene, camera);
        }

        init();
        animate();
    </script>
</body>
</html>
